<!-- $Id: top_frame.html,v 1.2 2004/12/01 17:02:14 jz Exp $ -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
    <meta name="vs_targetSchema"    content="http://schemas.microsoft.com/intellisense/ie5"/>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>

    <title>Scheduler</title>

    <style type="text/css">
        @import "scheduler.css";
        @import "custom.css";
    </style>
</head>


<body class="top">

    <table cellspacing="0" cellpadding="0" border="0" class="update" align="center">
        <tr>
            <td align="right" width="54%" class="update">
                <input id="update_periodically_checkbox" type="checkbox" onclick="update_periodically_checkbox__onclick()" NAME="update_periodically_checkbox"/>
                <label for="update_periodically_checkbox"><span class="translate">Update periodically</span></label>&#160; &#160;
            </td>
            <td width="46%" class="update">
                <input id="update_button" class="update_button" type="button" value="&nbsp;Update&nbsp;" onclick="update__onclick()" NAME="update_button"/> &#160;
            </td>
        </tr>
    </table>        
    <p class="after_update_space">&nbsp;</p>

<!--<span id="error_message" style="font-weight: bold; color: red"></span>-->

<span id="stylesheet_output"></span>

<script defer="true" type="text/javascript" src="scheduler.js" ></script>
<script defer="true" type="text/javascript" src="browser_dependencies.js" ></script>
<!--script defer="true" type="text/javascript" src="translation_de.js"></script-->
<script defer="true" type="text/javascript" src="popup_menu.js"></script>

<script defer="true" language="javascript"><!--
//--------------------------------------------------------------------------------------------const

var _max_orders = 10;

//----------------------------------------------------------------------------------------------var

var _stylesheet;
var _translation_table;
var _response;
var _timer;
var _scheduler;
var _show_card = "jobs";
//var _show_jobs            = true;
//var _show_job_chains      = false;
//var _show_process_classes = false;
var _checkbox_states = new Object();

_checkbox_states[ "show_order_jobs_checkbox" ] = true;
//var _update_periodically = false;

//-------------------------------------------------------------------------------------------onload

function do_onload()
{
    check_browser();    
    
    _stylesheet = new Stylesheet( "scheduler_top.xslt" );

    window.parent.document.title = "Scheduler " + document.location.host;
    
    if( typeof init_translation_table != "undefined" )
    {
        _translation_table = new Object();
        init_translation_table( _translation_table );
        
        // Auch für großgeschriebene Wörter:
        for( word in _translation_table )  _translation_table[ word.substring.substring( 0, 1 ).toUpper() + word.substring( 1 ) ];
    }
    
    _scheduler = new Scheduler();
    repeat_update( document.getElementById( "update_periodically_checkbox" ).checked, true );
    scheduler_init();
}

//-----------------------------------------------------------------------------------------onunload

function do_onunload()
{
    if( _scheduler )  _scheduler.close();
}

//------------------------------------------------------------update_periodically_checkbox__onclick

function update_periodically_checkbox__onclick()
{
    reset_error();
    repeat_update( document.getElementById( "update_periodically_checkbox" ).checked, 
                   document.getElementById( "update_periodically_checkbox" ).checked );
}

//--------------------------------------------------------------------------------------reset_error

function reset_error()
{
    parent.left_frame.document.getElementById( "error_message" ).innerHTML = "";
        
    window.status = "";
}

//------------------------------------------------------------------------------------repeat_update

function repeat_update( repeat, call_update )
{
    reset_error();
    if( _timer != undefined )  window.clearTimeout( _timer ),  _timer = undefined;
    
    try
    {
        if( call_update )
        {
            document.getElementById( "update_periodically_checkbox" ).checked = false;     
            update();
        }
    }
    catch( x )
    {   
        repeat = false;
        var msg = "";
        
        if( typeof x == "object" )
        {
            if( x.number + 0xFFFFFFFF == 0x800C0004 )  repeat = true,  msg = "Connection to Scheduler lost<br/>";
            msg += "0x" + hex_string( x.number, 8 ) + "&#160; " + xml_encode( x.message );
            msg += "<p> </p>";
        }
        else
            msg = xml_encode( x );
            
        parent.left_frame.document.getElementById( "error_message" ).innerHTML = msg;
    }    

    if( repeat )
    {
        document.getElementById( "update_periodically_checkbox" ).checked = true;
        set_update_timer();
    }
}

//---------------------------------------------------------------------------------set_update_timer

function set_update_timer()
{
    if( _timer != undefined )  window.clearTimeout( _timer ),  _timer = undefined;
    _timer = window.setTimeout( "repeat_update(true,true)", 5000, "JavaScript" );
}

//--------------------------------------------------------------------------------update_jobs_frame

function update_jobs_frame()
{
    var what       = "";
    var max_orders = 0;
    
    if( _checkbox_states.show_job_chain_orders_checkbox || window.parent.details_frame._job_chain_element )
    {
        what = "job_chain_orders";
        max_orders = window.parent.details_frame._job_chain_element? 9999 : _max_orders;
    }
    
    _response = _scheduler.execute( "<show_state what='" + what + "' max_orders='" + max_orders + "'/>" );
    modify_response( _response );
    var scheduler_id = _response.selectSingleNode( "spooler/answer/state" ).getAttribute( "id" );
    document.title = "Scheduler " + ( scheduler_id? " id=" + scheduler_id : "" );
    
    document.getElementById( "stylesheet_output" ).innerHTML = _stylesheet.xml_transform( _response );

    if( _translation_table )
    {    
        var span_elements = document.body.getElementsByTagName( "span" );
        for( var i = 0; i < span_elements.length; i++ )
        {
            var span_element = span_elements[i];
            if( span_element.getAttribute( "className" ) == "translate" )
            {
                var translation = _translation_table[ span_element.innerText ];
                if( translation )  span_element.innerText = translation, spanElement.removeAttribute( "className" );
            }
        }
    }
}

//-------------------------------------------------------------------------------------------update

function update()
{
    reset_error();
    update_jobs_frame();
    
    window.parent.left_frame.update();

    if( window.parent.details_frame.document.readyState == "complete" )
    {
        window.parent.details_frame.update();
    }
    
    if( _timer != undefined )  set_update_timer();
}

//----------------------------------------------------------------------------------modify_response

function modify_response( response )
{
    // Antwort manipulieren: <tasks> mit <task> auffüllen, bis <job tasks=".."> erreicht ist.

    var job_elements = response.selectNodes( ".//job" );
    for( var j = 0; j < job_elements.length; j++ )
    {
        var job_element = job_elements[j];
        
        var tasks_element = job_element.selectSingleNode( "tasks" );
        if( tasks_element )
        {
            var task_elements = tasks_element.selectNodes( "task" );
            var n = 1*job_element.getAttribute( "tasks" ) - task_elements.length;
            for( var t = 0; t < n; t++ )
            {
                tasks_element.appendChild( tasks_element.ownerDocument.createElement( "task" ) );
            }
        } 
    }
    

    // Werte der Checkboxen show_tasks_checkbox und show_my_orders ins XML-Dokument übernehmen (für XSL)
    
    var spooler_element = response.selectSingleNode( "spooler" );
    if( spooler_element )
    {    
        restore_checkbox_state( response, "show_order_jobs_checkbox" );
        restore_checkbox_state( response, "show_tasks_checkbox" );
        restore_checkbox_state( response, "show_job_chain_jobs_checkbox" );
        restore_checkbox_state( response, "show_job_chain_orders_checkbox" );

        spooler_element.setAttribute( "my_max_orders", _max_orders );
        spooler_element.setAttribute( "my_show_card" , _show_card );
    }
}

//------------------------------------------------------------------------------save_checkbox_state

function save_checkbox_state( name )
{
    if( document.getElementById( name ) )
    {
        _checkbox_states[ name ] = document.getElementById( name ).checked;
    }
}

//---------------------------------------------------------------------------restore_checkbox_state

function restore_checkbox_state( response, name )
{
    var spooler_element = response.selectSingleNode( "spooler" );
    if( spooler_element )
    {
        //if( document.all[ name ]  &&  document.all[ name ].checked )
        //{
         //   spooler_element.setAttribute( name, "yes" );
        //}
        //else
        {
            if( _checkbox_states[ name ] )  spooler_element.setAttribute( name, "yes" );
        }
    }
}

//-------------------------------------------------------------------------show_job_process_classes

function show_card( what )
{
    if( what != _show_card )
    {
        if( what == "process_classes" )
        {
            window.parent.details_frame.clear();
            
            //_saved_frameset_cols = window.parent.left_and_right_frameset.cols; 
            //window.parent.left_and_right_frameset.cols = "100%, 0%";
        }
        //else
        //if( _saved_frameset_cols != undefined )
        {
            //window.parent.left_and_right_frameset.cols = _saved_frameset_cols;
            //_saved_frameset_cols = undefined;
        }
    
        _show_card = what;
    }
    
    update();
}

//--------------------------------------------------------------------------------show_task_details

function show_task_details( job_name, task_id )
{
    var job_element  = _response.selectSingleNode( ".//job[@job='" + job_name + "']" );
    var task_element = _response.selectSingleNode( ".//task[@id=" + task_id + "]" );

    update_jobs_frame();
    window.parent.details_frame.show_task_details( job_element, task_element );
}

//---------------------------------------------------------------------------------show_job_details

function show_job_details( job_name )
{
    var job_element  = _response.selectSingleNode( ".//job[@job='" + job_name + "']" );

    window.parent.details_frame.show_job_details( job_element );
    update_jobs_frame();
}

//---------------------------------------------------------------------------show_job_chain_details

function show_job_chain_details( job_chain_name )
{
    var job_chain_element = _response.selectSingleNode( ".//job_chain[@name='" + job_chain_name + "']" );

    window.parent.details_frame.show_job_chain_details( job_chain_element );
    update();
}

//-------------------------------------------------------------------------------------------------
/*
Node.prototype.__defineGetter__( "xml", _Node_getXML );

function _Node_getXML() 
{
    return new XMLSerializer().serializeToString( this );
}
Now, the Mozilla interface can use the xml attribute in the same way that IE uses it.

*/
--></script>


<script defer="true" type="text/javascript" for="window" event="onload"  > do_onload();   </script>
<script defer="true" type="text/javascript" for="window" event="onunload"> do_onunload(); </script>


</body>

</html>
